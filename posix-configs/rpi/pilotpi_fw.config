#!/bin/sh
# PX4 commands need the 'px4-' prefix in bash.
# (px4-alias.sh is expected to be in the PATH)
. px4-alias.sh

if [ ! -f eeprom/parameters ]; then
    param save eeprom/parameters
fi
param select eeprom/parameters
param import

param touch SYS_AUTOCONFIG
param touch COM_FLTMODE1
param touch COM_FLTMODE2
param touch COM_FLTMODE3
param touch COM_FLTMODE4
param touch COM_FLTMODE5
param touch COM_FLTMODE6
param touch COM_RC_LOSS_T

# always enable Dynamic Control Allocation
param set SYS_CTRL_ALLOC 1

# system_power not implemented
param set CBRK_SUPPLY_CHK 894281

# 1K + 4.7K voltage divider
param set-default BAT1_V_DIV 5.7

# manually setup airframe type
param set MAV_TYPE 1
param set-default CA_AIRFRAME 1
param set SYS_AUTOSTART 2100  # no effect on Linux

dataman start

load_mon start

battery_status start

# internal IMU
if ! icm42688p start -q -s -R 4
then
	# some boards has ICM42605 instead
	icm42605 start -s -R 4
fi
if ! ist8310 start -q -I -a 15 -R 4
then
	# some boards has QMC5883l instead
	qmc5883l start -I -R 6
fi
ms5611 start -I

# ADC
ads1115 start -I

# PWM
pca9685_pwm_out start
control_allocator start

# external GPS & compass
gps start -d /dev/ttySC0 -i uart -p ubx -s
#hmc5883 start -X
#ist8310 start -X

# Airspeed
ms4525_airspeed start -X

rc_input start -d /dev/ttyAMA0

rc_update start
sensors start
commander start
navigator start
ekf2 start
airspeed_selector start
land_detector start fixedwing
flight_mode_manager start
fw_att_control start
fw_pos_control_l1 start

mavlink start -x -u 14556 -r 1000000 -p

# Telem
mavlink start -x -Z -d /dev/ttySC1

logger start -t -b 200

mavlink boot_complete
