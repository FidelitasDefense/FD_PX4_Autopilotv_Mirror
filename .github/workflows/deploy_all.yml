name: Deploy metadata for all targets

on:
  push:
    branches:
    - 'main'
    - 'release/*'
    - 'pr-metadata-test'
  pull_request:
    branches:
    - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: px4io/px4-dev-nuttx-focal:2021-09-08
    steps:
    - uses: actions/checkout@v1
      with:
        token: ${{secrets.ACCESS_TOKEN}}

    - name: Check Git branch
      run: |
        echo "Git branch:"
        echo $(git branch)

    - name: make target
      run: make px4_fmu-v5_default

    - name: parameter & events metadata
      run: |
        make px4_fmu-v5_default ver_gen

        echo "Version tag detected: "
        echo $(./src/lib/version/get_git_tag_or_branch_version.sh build/px4_fmu-v5_default)

        ./src/lib/version/get_git_tag_or_branch_version.sh build/px4_fmu-v5_default >> $GITHUB_ENV

        echo "Github ENV:"
        echo $(cat $GITHUB_ENV)
        echo $env.version

    - name: Check environment variables
      run: |
        echo "Version:"
        echo $version
        echo "Envs:"
        echo $(env)

    - uses: jakejarvis/s3-sync-action@master
      with:
        args: --acl public-read
      env:
        AWS_S3_BUCKET: 'px4-travis'
        AWS_ACCESS_KEY_ID: ASDFJJGS + DFS ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ASDF ASDF + ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: 'us-west-1'
        SOURCE_DIR: 'build/px4_fmu-v5_default/_metadata/'
        DEST_DIR: 'Firmware/${{ env.version }}/px4_fmu-v5_default/'
