#Jonas 04022025

name: "CodeQL Advanced CPP"


on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 1 * * 1'  # Fixed space in cron syntax
jobs:
  analyze:
    name: Analyze Code with CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake g++ gcc
          
      # Verify C++ files exist and show their locations
      - name: List C++ Files
        run: |
          echo "C/C++ files in repository:"
          find . -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.c" -o -name "*.h" -o -name "*.hpp" \)
          
      - name: Initialize CodeQL with Traces
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          debug: true
          # Create a trace log to see what commands are being captured
          config-file: ./.github/codeql/codeql-config.yml || echo "No custom config found, using defaults"
          
      # Use autobuild instead of custom build commands
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
        
      # If autobuild fails, try direct compilation
      - name: Manual Compilation Fallback
        if: ${{ always() }}
        run: |
          echo "Attempting direct compilation of C/C++ files..."
          for file in $(find . -type f -name "*.cpp" -o -name "*.cc" -o -name "*.c"); do
            echo "Compiling $file"
            g++ -c "$file" -I. -I./include -std=c++11 || echo "Failed to compile $file (continuing)"
          done
          
      - name: Check Compilation Artifacts
        run: |
          echo "Checking for compiled object files:"
          find . -type f -name "*.o" | wc -l
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:cpp"
